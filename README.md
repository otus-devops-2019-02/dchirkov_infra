[![Build Status](https://travis-ci.com/otus-devops-2019-02/dchirkov_infra.svg?branch=master)](https://travis-ci.com/otus-devops-2019-02/dchirkov_infra)

# dchirkov_infra

<details>
<summary>ДЗ к занятию 5</summary>

## ДЗ к занятию 5

### SSH-подключение к внутреннему хосту в одну команду

Подключение к не имеющей внешнего доступа ВМ *someinternalhost (10.154.0.3)* с локального компьютера через ВМ *bastion (35.205.222.9)* можно набрав команду:

```
ssh -J dmitry_n_chirkov@35.205.222.9 dmitry_n_chirkov@10.154.0.3
```

\* опция -J появилась в версии OpenSSH 7.3

### SSH-подключение к внутреннему хосту по алиасу

Для подключения по алиасу нужно создать config-файл пользователя на локальной машине:

```bash
$ cat .ssh/config
Host bastion
   HostName 35.205.222.9
   User dmitry_n_chirkov
Host someinternalhost
   HostName 10.154.0.3
   ProxyJump bastion
   User dmitry_n_chirkov
```

### Подключение по VPN

Конфигурация файла setupvpn.sh изменена на версию Ubuntu 18.04 (bionic).
Подключение к VPN осуществляется по доменному имени bastion-vpn.linux.technology
Установен сертификат Let's Encrypt.

Данные для подключения:

```
bastion_IP = 35.205.222.9
someinternalhost_IP = 10.154.0.3
```
</details>

<details>
<summary>ДЗ к занятию 6</summary>

## ДЗ к занятию 6

Данные для подключения:

```
testapp_IP = 35.240.16.90
testapp_port = 9292
```

### Создание ВМ с автозапуском скрипта

```bash
gcloud compute instances create reddit-app --boot-disk-size=10GB \
--image-family ubuntu-1604-lts --image-project=ubuntu-os-cloud \
--machine-type=g1-small --tags puma-server --restart-on-failure \
--metadata-from-file startup-script=dchirkov_infra/startup_script.sh \
--zone europe-west1-b
```

### Создание правила файервола посредством команды gcloud

```bash
gcloud compute firewall-rules create default-puma-server --allow=tcp:9292 --target-tags puma-server
```
</details>

<details>
<summary>ДЗ к занятию 7</summary>

## ДЗ к занятию 7

Сделано:

* Создан шаблон ubuntu16 для packer с приложениями ruby и mongodb
* Создано семейство образов reddit-base в Google Cloud средствами packer
* Создан шаблон immutable для packer с нашим приложением reddit
* Настроен автозапуск приложения reddit
* Создано семейство образов reddit-full в Google Cloud средствами packer
</details>

<details>
<summary>ДЗ к занятию 8</summary>

## ДЗ к занятию 8

### Описание задания со *

При добавлении ssh-keys других пользователей средствами terraform в ВМ добавляется последний пользователь в коде.

При добавлении ssh-ключа пользователя appuser_web в веб-интерфейсе в метаданные проекта, в ВМ создается пользователь, но
при применении terraform apply он удалится.

### Описание задания со **

При добавлении балансировщика перед приложением мы повышаем его отказоустойчивость.

При добавлении ВМ с помощью ресурса google_compute_instance мы увеличиваем сложность и поддерживаемость кода.

Количество однотипных ресурсов задается параметром count, ресурс вызывается следующим образом:

```
<resource>.<name>.<numcount>
```
</details>

<details>
<summary>ДЗ к занятию 9</summary>

## ДЗ к занятию 9

Сделано:

* Импортировал существующее правило файервола в файл состояния терраформ (terraform import)
* Проверил взаимосвязи ресурсов на примере создания ресурса IP-адреса
* Средствами packer создал два новых шаблона для app и db
* Созданы модули для app, db и vpc
* Проверил работу параметризации модулей (на примере файервола)
* Создал две директории с конфигурационными файлами для stage и prod
* Создал хранилище с помощью модуля storage-bucket из реестра модулей

### Описание задания со *

При добавлении бекенда gcs, файл состояния переноситься в google bucket, файл блокировок создается там же.

При последовательном запуске конфигурации из одной директории, в другой директории этого же проекта terraform выведет что конфигурация уже применена (из-за единого файла состояния).

При одновременном запуске конфигурации из одной директории, в другой директории этого же проекта terraform не даст что-либо делать (из-за блокировки).

### Описание задания со **

Добавил необходимые provisioner для деплоя приложения, для работы приложения в инстансе db поправил файл /etc/mongod.conf,
в инстансе app добавил окружение DATABASE_URL с внутренним IP инстанса db.
</details>

<details>
<summary>ДЗ к занятию 10</summary>

## ДЗ к занятию 10

Если в выводе команд ansible или ansible-playbook есть:

```
changed=1
```
 
то на сервере произошли изменения

Отличие схем JSON для динамического и статического инвентори:

* В первом случае присутствует элемент верхнего уровня _meta, в котором перечислены все переменные для хостов
* Все хосты в группах перечисляются в квадратных скобках

Мой файл динамического инвентори inventory.sh неполноценный. При выполнении команды 

```
inventory.sh --list
```

она сформирует список внешних IP-адресов инстансов и вернет правильно оформленный JSON-шаблон, предварительно их подставив.

По-хорошему нужно было написать такой скрипт (не важно на каком языке), который при выполнении в цикле смотрит какие инстансы есть
и формирует правильный JSON-шаблон (с _meta, группами, хостами и переменными хостов). 
Этот исполняемый файл нужно использовать как файл инвентори (либо указав в параметре -i, либо в файле ansible.cfg в переменной inventory) 
</details>

<details>
<summary>ДЗ к занятию 11</summary>

## ДЗ к занятию 11

Сделано:

* Создан плейбук с одним сценарием для деплоя приложения
* Создан плейбук с несколькими сценариями для деплоя приложения
* Созданы три плейбука для настройки сервера прилодений, базы данных и деплоя кода 
* Изменен провижиниг в packer на ansible 

### Описание задания со *

Для динамической инвентаризации инстансов можно использовать написанный сообществом ansible скрипт gce.py, или использовать
плагин инвентаризации Google: gcp_compute. 

Согласно документации ansible последний вариант является рекомендуемым, его и будем использовать.

**Настройка:**

* установить необходимые зависимости:
```bash
$ pip install requests google-auth
```

* в Google IAM & admin создать сервисную учетную запись и ключ для проекта 
* скачать файл авторизации в формате JSON
* в ansible.cfg включить этот плагин:
```
[inventory]
enable_plugins = gcp_compute
```
* создать файл инвентаризации inventory.gcp.yml в правильном формате и добавить в ansible.cfg
```
inventory = inventory.gcp.yml
```
* проверить командой
```bash
$ ansible-inventory --list -y
```
</details>

## ДЗ к занятию 12

Сделано:

* Созданы две роли app и db
* Созданы окружения
* Наведен порядок в директории ansible
* Установлена community-роль jdauphant.nginx
* В конфигурацию terraform добавлено правило для открытия порта 80/tcp 
* Зашифрованы два файла с данными пользователей посредством ansible-vault

### Описание задания со *

Динамическая инвентаризация настроена аналогичным образом, как и в предыдущем занятии. 

### Описание задания со **

Создан скрипт для проверки инфраструктурного кода play-travis/mytests.sh 
